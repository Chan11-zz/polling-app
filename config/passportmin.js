"use strict"
function validateEmail(e){var a=/\S+@\S+\.\S+/
return a.test(e)}var db=require("./dbmin.js"),userDetails=require("./userDetails.js")
db.connectMongo()
var easyMongo=db.easyMongo,LocalStrategy=require("passport-local").Strategy
module.exports=function(e){function a(e,a,s,l){process.nextTick(function(){easyMongo(db.findDoc,"users",{email:a}).then(function(i){return validateEmail(a)?null!=i&&i.email==a?l(null,!1,e.flash("message","This email is already taken.")):(userDetails.local.password=s,userDetails.local.id=userDetails.generateHash(a),userDetails.local.email=a,easyMongo(db.insertDoc,"users",{id:userDetails.local.id,email:userDetails.local.email,password:userDetails.local.password}).then(function(e){return l(null,{id:userDetails.local.id,email:userDetails.local.email,password:userDetails.local.password})}),void 0):l(null,!1,e.flash("message","Not a valid email address"))})})}function s(e,a,s,l){process.nextTick(function(){easyMongo(db.findDoc,"users",{email:a}).then(function(i){return null!==i&&i.email==a&&i.password==s?(userDetails.local.password=i.password,userDetails.local.id=i.id,userDetails.local.email=i.email,l(null,{id:userDetails.local.id,email:userDetails.local.email,password:userDetails.local.password})):l(null,!1,e.flash("message","Not a valid password or email."))})})}e.serializeUser(function(e,a){a(null,e.id)}),e.deserializeUser(function(e,a){a(null,e)}),e.use("local-signup",new LocalStrategy({usernameField:"email",passwordField:"password",passReqToCallback:!0},a)),e.use("local-login",new LocalStrategy({usernameField:"email",passwordField:"password",passReqToCallback:!0},s))}
