var db=require("./config/dbmin.js"),easyMongo=db.easyMongo,userDetails=require("./config/userDetails.js"),name=userDetails.local.email.slice(0,userDetails.local.email.indexOf("@")),id=userDetails.local.id;module.exports=function(a,b){function c(a,b,c){console.log("Authenticating..."),a.isAuthenticated()?c():b.redirect("/")}function d(a){var b=[],c={};for(var d in a)b.push(a[d]),c[a[d]]=0;var e=userDetails.generateHash(b[0]),f=userDetails.local.email.slice(0,userDetails.local.email.indexOf("@")),g=userDetails.local.id;console.log("nameurl ",f,g,e),easyMongo(db.insertDoc,"questions",{id:g,name:f,data:b,url:e.slice(-18).replace(/([^\w])/g,""),votes:c})}function e(a,b,c){a=a.substring(1),easyMongo(db.findDoc,"questions",{url:a}).then(function(c){null==c?b.redirect(301,"/"):b.render("pollresult",{url:a})})}a.delete("/deletemyquestions/:url",function(a,b){var c=a.params.url;b.status(200),b.send("ok"),console.log("id: in delete request",c),easyMongo(db.deleteDoc,"questions",{url:c})}),a.use(function(a,b,c){switch(console.log("in use",a.path),a.path){case"/postpollquestions":case"/":case"/signup":case"/dashboard":case"/main":case"/login":case"/poll":case"/index":case"/logout":case"/allquestions":case"/profile":case"/myquestions":c();break;default:e(a.path,b,c)}}),a.get("/",function(a,b){console.log("in index"),b.render("index.ejs")}),a.get("/login",function(a,b){b.render("login.ejs",{message:a.flash("message")})}),a.post("/login",b.authenticate("local-login",{successRedirect:"/main",failureRedirect:"/login",failureFlash:!0})),a.get("/signup",function(a,b){b.render("signup.ejs",{message:a.flash("message")})}),a.post("/signup",b.authenticate("local-signup",{failureRedirect:"/signup",failureFlash:!0}),function(a,b){console.log("registered,redirecting now..."),b.redirect("/main")}),a.get("/profile",c,function(a,b){console.log("in profile"),a.flash("message","Welcome");var c=userDetails.local.email.slice(0,userDetails.local.email.indexOf("@"));b.render("profile.ejs",{message:a.flash("message"),name:c})}),a.get("/myquestions",function(a,b){var c=userDetails.local.id;console.log("in myquestions,myid:",c),easyMongo(db.findDocToArray,"questions",{id:c}).then(function(a){b.json(a)})}),a.get("/logout",function(a,b){a.logout(),b.redirect("/")}),a.get("/dashboard",c,function(a,b){b.render("dashboard")}),a.post("/dashboard",function(a,b){d(a.body),b.redirect(303,"/main")}),a.post("/postpollquestions",function(a,b){console.log(a.body,"body from post poll questions");var c=a.body.name.split(","),d=c[1],e=`votes.${c[0]}`,f={};f[e]=1,b.redirect(301,"/"+d),db.updateDoc({url:d},{$inc:f},"questions").then(function(a){console.log("updated")})}),a.get("/main",c,function(a,b){b.render("main")}),a.get("/allquestions",function(a,b){easyMongo(db.findDocToArray,"questions",{}).then(function(a){b.json(a)})})};
